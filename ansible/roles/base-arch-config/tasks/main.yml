---
- name: enable colorful output in pacman.conf
  become: yes
  become_user: root
  replace:
    path: /etc/pacman.conf
    regexp: '^#\s*Color.*$'
    replace: 'Color'

- name: init pacman-key
  become: yes
  become_user: root
  command: "pacman-key --init"

- name: populate archlinuxarm pacman-key
  become: yes
  become_user: root
  command: "pacman-key --populate archlinuxarm"

- name: upgrade all packages
  become: yes
  become_user: root
  pacman:
    update_cache: yes
    upgrade: yes

# Install base packages
- include: packages/yay.yml
- include: packages/htop.yml
- include: packages/dbus.yml
- include: packages/avahi.yml
- include: packages/timesync.yml
- include: packages/ethtool.yml
- include: packages/socat.yml
- include: packages/iptables.yml
- include: packages/lvm.yml
- include: packages/systemd-resolved.yml
- include: packages/nettools.yml

- include: leds/act.yml
  when: act_led_disabled

- include: leds/pwr.yml
  when: pwr_led_disabled

- name: Enable cgroups_memory # needed for kubeadm
  become: yes
  become_user: root
  lineinfile:
    path: /boot/cmdline.txt
    regexp: '(?=.*root)(?!.*cgroup_enable=memory)(.+)'
    backrefs: yes
    line: '\1 cgroup_enable=memory'

- name: Disable swap for this session
  become: yes
  become_user: root
  shell: |
    swapoff -a

- name: Disable swap in systemd
  become: yes
  become_user: root
  shell: >
    systemctl mask dev-zram0.swap
    systemctl mask sys-devices-virtual-block-zram0.device
    systemctl mask zswap-arm.service

- name: Disable swap permanently, persist reboots
  become: yes
  become_user: root
  replace:
    path: /etc/fstab
    regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
    replace: '#\1\2\3swap\4'
    backup: yes
